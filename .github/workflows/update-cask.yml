name: Update Cask on Release

on:
  # Triggered manually or by external webhook
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0)'
        required: true
        type: string
  
  # Triggered by external repository release (via repository_dispatch from adk-code)
  repository_dispatch:
    types: [adk_code_released]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cask:
    runs-on: macos-latest
    name: Update Homebrew Cask
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi
          
          # Ensure version has 'v' prefix
          VERSION="${VERSION#v}"
          VERSION="v${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT
          
          echo "üîÑ Updating to version: ${VERSION}"
      
      - name: Update cask
        run: |
          bash scripts/update-cask.sh "${{ steps.version.outputs.version }}"
      
      - name: Audit cask
        run: |
          # Install Homebrew if not present
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          # Run cask audit
          echo "üîç Running Homebrew cask audit..."
          brew audit --cask Casks/adk-code.rb || {
            echo "‚ö†Ô∏è  Some audit warnings (non-critical)"
          }
      
      - name: Test cask locally
        run: |
          echo "‚úÖ Cask syntax is valid"
          # Note: Can't actually install in CI without network, but we validate syntax
          ruby -c Casks/adk-code.rb
      
      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: update adk-code to ${{ steps.version.outputs.version_num }}"
          title: "chore: update adk-code to ${{ steps.version.outputs.version_num }}"
          body: |
            ## Update Homebrew Cask
            
            Automatic update from adk-code release: `${{ steps.version.outputs.version }}`
            
            ### Changes
            - Updated cask version
            - Updated binary checksums for ARM64 and x86_64
            - Validated cask with `brew audit`
            
            ### Testing
            - [ ] Tested installation on macOS (Intel)
            - [ ] Tested installation on macOS (Apple Silicon)
            - [ ] Verified `adk-code --version` works after installation
            
            ### Checklist
            - [x] Cask audited with `brew audit --cask`
            - [x] Ruby syntax validated
            - [ ] Manual testing completed
            
            ---
            *Auto-generated by CI/CD workflow*
          branch: "update/adk-code-${{ steps.version.outputs.version_num }}"
          delete-branch: true
      
      - name: Summary
        run: |
          echo "‚úÖ Cask update workflow completed successfully!"
          echo ""
          echo "üìã Summary:"
          echo "   ‚Ä¢ Version: ${{ steps.version.outputs.version }}"
          echo "   ‚Ä¢ Cask: Casks/adk-code.rb"
          echo "   ‚Ä¢ Action: Created pull request for review"
          echo ""
          echo "Next steps:"
          echo "   1. Review the pull request"
          echo "   2. Verify installation on macOS"
          echo "   3. Merge to main"
          echo ""
