name: Update Cask on Release

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0)'
        required: true
        type: string

  # Triggered by external repository release (via repository_dispatch from adk-code)
  repository_dispatch:
    types: [adk_code_released]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cask:
    runs-on: macos-latest
    name: Update Homebrew Cask

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi

          # Ensure version has 'v' prefix
          VERSION="${VERSION#v}"
          VERSION="v${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT

          echo "üîÑ Updating to version: ${VERSION}"

      - name: Download and verify binaries
        run: |
          VERSION="${{ steps.version.outputs.version_num }}"
          TAG="v${VERSION}"

          echo "üì• Downloading binaries for version ${VERSION}..."

          # Download ARM64 binary
          curl -L -o "adk-code-${TAG}-darwin-arm64" \
            "https://github.com/raphaelmansuy/adk-code/releases/download/${TAG}/adk-code-${TAG}-darwin-arm64"

          # Download AMD64 binary
          curl -L -o "adk-code-${TAG}-darwin-amd64" \
            "https://github.com/raphaelmansuy/adk-code/releases/download/${TAG}/adk-code-${TAG}-darwin-amd64"

          # Verify binaries are valid Mach-O executables
          file "adk-code-${TAG}-darwin-arm64" | grep -q "Mach-O" || {
            echo "‚ùå ARM64 binary is not a valid Mach-O executable"
            exit 1
          }
          file "adk-code-${TAG}-darwin-amd64" | grep -q "Mach-O" || {
            echo "‚ùå AMD64 binary is not a valid Mach-O executable"
            exit 1
          }

          echo "‚úÖ Binaries verified successfully"

      - name: Audit cask
        run: |
          # Install Homebrew if not present
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Run cask audit (syntax check only since we use :latest)
          echo "üîç Running Homebrew cask audit..."
          brew audit --cask Casks/adk-code.rb || {
            echo "‚ö†Ô∏è  Some audit warnings (may be expected for :latest casks)"
          }

      - name: Test cask locally
        run: |
          echo "‚úÖ Cask syntax is valid"
          # Note: Can't actually install in CI without network, but we validate syntax
          ruby -c Casks/adk-code.rb

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: update adk-code to ${{ steps.version.outputs.version_num }}"
          title: "chore: update adk-code to ${{ steps.version.outputs.version_num }}"
          body: |
            ## Update Homebrew Cask

            Automatic update from adk-code release: `${{ steps.version.outputs.version }}`

            ### Changes
            - Cask remains configured for automatic latest version distribution
            - Verified binary integrity for both ARM64 and AMD64 architectures
            - Validated cask with `brew audit`

            ### Testing
            - [x] Binaries verified as valid Mach-O executables
            - [x] Cask audited with `brew audit --cask`
            - [x] Ruby syntax validated
            - [ ] Manual testing completed (see checklist below)

            ### Manual Testing Checklist
            - [ ] Tested installation on macOS (Intel): `brew install raphaelmansuy/adk-code/adk-code`
            - [ ] Tested installation on macOS (Apple Silicon): `brew install raphaelmansuy/adk-code/adk-code`
            - [ ] Verified `adk-code --version` works after installation
            - [ ] Confirmed automatic updates work: `brew upgrade adk-code`

            ### Notes
            This cask uses `version :latest` for automatic distribution of the newest release.
            Users get the latest version automatically without manual cask updates.

            ---
            *Auto-generated by CI/CD workflow*
          branch: "update/adk-code-${{ steps.version.outputs.version_num }}"
          delete-branch: true

      - name: Summary
        run: |
          echo "‚úÖ Cask update workflow completed successfully!"
          echo ""
          echo "üìã Summary:"
          echo "   ‚Ä¢ Version: ${{ steps.version.outputs.version }}"
          echo "   ‚Ä¢ Cask: Casks/adk-code.rb"
          echo "   ‚Ä¢ Action: Created pull request for review"
          echo ""
          echo "Next steps:"
          echo "   1. Review the pull request"
          echo "   2. Verify installation on macOS"
          echo "   3. Merge to main"